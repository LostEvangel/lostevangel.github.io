---
title: JVM内存模型和对象
date: 2019-4-15 14:34:34
tags: [面试,JVM]
categories: [面试,JVM]
description: JVM的内存模型和对象
---

# JVM内存模型和对象

## 1. Java内存区域

![jvm.jpg](\image\interview_prep\jvm.jpg)

### 1.1 程序计数器

程序计数器（Program Counter Register）是一块较小的内存空间，可以看做是当前线程所执行的字节码的行号指示器。

如果是执行java方法，计数器记录的是正在执行的虚拟机字节码指令的地址；如果native方法，计数器值为空。

不会发生任何OutOfMemoryError。

### 1.2 Java虚拟机栈

线程私有。虚拟机栈描述的是Java方法执行的内存模型：每个方法在执行的同时会创建一个栈帧，用于存储局部变量表、操作数栈、动态链接、方法出口等信息。

局部变量表存放了编译器可知的各种基础数据类型（boolean、byte、char、short、int、long、float、double）、对象引用（reference类型，不是对象本身，是一个指向对象起始地址的引用指针，或者是指向一个代表对象的句柄或者其他与此对象相关的位置）和returnAddress类型（指向了一条字节码指令的地址）。

如果扩展时无法申请到足够的内存，会抛出OutOfMemoryError异常。

### 1.3 本地方法栈

与虚拟机栈类似，为执行的Native方法服务。

会抛出OutOfMemoryError异常和StackOverflowError异常。

### 1.4 Java堆

Java虚拟机的内存最大的。被所有线程共享。唯一目的是存放对象实例。

Java堆是垃圾收集器管理的主要区域。细分为：新生代、老年代。

如果在堆中没有内存完成实例分配，而且堆无法扩展，会OutOfMemoryError异常。

### 1.5 方法区

线程共享。存储虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等。可以不实现垃圾收集。

当方法区无法满足内存分配需求，OutOfMemoryError异常。

### 1.6 运行时常量池

是方法区的一部分。Class文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译器生成的各种字面量和符号引用，这些内容在类加载时进入该区域。

无法满足内存分配需求，OutOfMemoryError异常。

### 1.7 直接内存

直接内存不是运行时数据区的一部分，但可能导致OutOfMemoryError。

## 2. JVM中的对象

指的是普通对象，不是数据和Class对象。

### 2.1 对象的创建

JVM遇到一个new时，先检查这个指令的参数是否能在常量池中定位到一个类的符号引用，并检查该符号引用代表的类是否被加载、解析和初始化过。如果没有，必须先执行响应的类加载。

类加载后，为新生对象分配内存，分配任务相当于把一块确定大小的内存从Java堆中划分出来。

内存分配完成后，JVM将分配到的内存初始化为零值。

然后，JVM对对象进行必要的设置，如属于哪个类的实例、对象的哈希码、GC分代年龄等信息，存放到对象的对象头。

此时，JVM中的新对象已产生，接着可以执行init方法。我们根据需要进行初始化，生产我们想用的对象。

#### 2.1.1 分配策略

由Java堆是否规整决定，是否规整由GC是否带有压缩功能决定。

- 指针碰撞：规整。由一个指针作为使用和空闲内存的分割指示器。
- 空闲列表：不规整。维护一个列表记录是否可用。

#### 2.1.2 线程安全解决方案

- 对分配内存空间的动作做同步处理
- 使用本地线程分配缓冲

### 2.2 对象的内存布局

分为：对象头、实例数据和对齐填充。

#### 2.2.1 对象头

分为两部分。

第一部分用于**存储对象自身的运行时数据**，如HashCode、GC分代年龄、锁状态标志、线程特有的锁、偏向线程ID、偏向时间戳等。

另一部分是**类型指针**，即对象指向它的类元数据的指针，虚拟机通过该指针来确定这个对象是哪个类的实例。

#### 2.2.2 实例数据

对象真正存储的有效信息，也是在程序中定义的各种类型的字段内容。

#### 2.2.3 对齐填充

不必然存在，没特别意义，只是占位符的作用。

### 2.3 对象的访问定位

程序通过栈上的reference数据来操作栈上的具体对象。访问方式有两种：

- 句柄：堆中划分出一块内存作为句柄池，reference存储的是对象句柄的地址，句柄中存的是实例数据和类型数据各自的具体地址。

- 直接指针：堆要存放基础数据相关信息。reference存储的是对象地址。